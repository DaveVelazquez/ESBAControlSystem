name: Apply Database Migrations

on:
  workflow_dispatch:
    inputs:
      migration_file:
        description: 'Migration file to apply (e.g., 004_create_clients_tables.sql)'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 507297234735
  ECR_REPOSITORY: field-service-backend

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
      
      - name: Get Backend Image
        id: image
        run: |
          IMAGE_URI=$(aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
            --output text)
          
          FULL_IMAGE="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_URI"
          echo "image=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "‚úÖ Using image: $FULL_IMAGE"
      
      - name: Execute Migration
        env:
          DB_HOST: db.nphuclchphpnqawzzueb.supabase.co
          DB_PORT: 5432
          DB_NAME: postgres
          DB_USER: postgres
          DB_PASS: ${{ secrets.SUPABASE_PASSWORD }}
        run: |
          # Build DATABASE_URL from components
          if [ -z "$DB_PASS" ]; then
            echo "‚ùå SUPABASE_PASSWORD secret not configured"
            echo ""
            echo "Please add SUPABASE_PASSWORD to GitHub Secrets:"
            echo "https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          
          DATABASE_URL="postgresql://${DB_USER}:${DB_PASS}@${DB_HOST}:${DB_PORT}/${DB_NAME}"
          
          MIGRATION_FILE="backend/migrations/${{ github.event.inputs.migration_file }}"
          
          if [ ! -f "$MIGRATION_FILE" ]; then
            echo "‚ùå Migration file not found: $MIGRATION_FILE"
            exit 1
          fi
          
          echo "üìÑ Migration file: $MIGRATION_FILE"
          echo "üîó Connecting to: ${DB_HOST}:${DB_PORT}/${DB_NAME}"
          echo ""
          echo "üöÄ Executing migration..."
          
          # Read migration file and execute via Node.js with pg
          docker run --rm \
            -e DATABASE_URL="$DATABASE_URL" \
            -v $(pwd)/backend/migrations:/migrations:ro \
            ${{ steps.image.outputs.image }} \
            node -e "
              const { Client } = require('pg');
              const fs = require('fs');
              
              (async () => {
                const client = new Client({ connectionString: process.env.DATABASE_URL });
                await client.connect();
                
                const sql = fs.readFileSync('/migrations/${{ github.event.inputs.migration_file }}', 'utf8');
                console.log('Executing migration...');
                await client.query(sql);
                console.log('‚úÖ Migration completed');
                
                await client.end();
              })().catch(err => {
                console.error('‚ùå Error:', err.message);
                process.exit(1);
              });
            "
          
          echo ""
          echo "‚úÖ Migration applied successfully"
      
      - name: Verify Tables
        env:
          DB_HOST: db.nphuclchphpnqawzzueb.supabase.co
          DB_PORT: 5432
          DB_NAME: postgres
          DB_USER: postgres
          DB_PASS: ${{ secrets.SUPABASE_PASSWORD }}
        run: |
          DATABASE_URL="postgresql://${DB_USER}:${DB_PASS}@${DB_HOST}:${DB_PORT}/${DB_NAME}"
          
          echo "üìä Verifying database schema..."
          docker run --rm \
            -e DATABASE_URL="$DATABASE_URL" \
            ${{ steps.image.outputs.image }} \
            node -e "
              const { Client } = require('pg');
              
              (async () => {
                const client = new Client({ connectionString: process.env.DATABASE_URL });
                await client.connect();
                
                const result = await client.query(\`
                  SELECT table_name 
                  FROM information_schema.tables 
                  WHERE table_schema = 'public' 
                  ORDER BY table_name;
                \`);
                
                console.log('\\nüìä Database Tables:');
                console.log('===================');
                result.rows.forEach(row => console.log('  - ' + row.table_name));
                console.log('');
                
                await client.end();
              })().catch(err => {
                console.error('‚ùå Error:', err.message);
                process.exit(1);
              });
            "
      
      - name: Results
        run: |
          echo "‚úÖ Migration completed successfully"
          echo ""
          echo "Applied: ${{ github.event.inputs.migration_file }}"
          echo ""
          echo "Next steps:"
          echo "1. Deploy updated backend: https://github.com/${{ github.repository }}/actions/workflows/deploy-backend.yml"
          echo "2. Deploy updated frontend: https://github.com/${{ github.repository }}/actions/workflows/update-frontend.yml"
