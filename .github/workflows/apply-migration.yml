name: Apply Database Migrations

on:
  workflow_dispatch:
    inputs:
      migration_file:
        description: 'Migration file to apply (e.g., 004_create_clients_tables.sql)'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 507297234735
  ECR_REPOSITORY: field-service-backend

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
      
      - name: Get Backend Image
        id: image
        run: |
          IMAGE_URI=$(aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
            --output text)
          
          FULL_IMAGE="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_URI"
          echo "image=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "‚úÖ Using image: $FULL_IMAGE"
      
      - name: Get Database URL from Task Definition
        id: db
        run: |
          DB_URL=$(aws ecs describe-task-definition \
            --task-definition field-service-backend \
            --query 'taskDefinition.containerDefinitions[0].environment[?name==`DATABASE_URL`].value' \
            --output text)
          
          if [ -z "$DB_URL" ]; then
            echo "‚ùå DATABASE_URL not found in task definition"
            exit 1
          fi
          
          echo "‚úÖ Found DATABASE_URL in task definition"
          echo "database_url=$DB_URL" >> $GITHUB_OUTPUT
      
      - name: Execute Migration
        run: |
          MIGRATION_FILE="backend/migrations/${{ github.event.inputs.migration_file }}"
          
          if [ ! -f "$MIGRATION_FILE" ]; then
            echo "‚ùå Migration file not found: $MIGRATION_FILE"
            exit 1
          fi
          
          echo "üìÑ Migration file: $MIGRATION_FILE"
          echo ""
          echo "üöÄ Executing migration in Docker container..."
          
          docker run --rm \
            -e DATABASE_URL="${{ steps.db.outputs.database_url }}" \
            -v $(pwd)/backend/migrations:/migrations:ro \
            ${{ steps.image.outputs.image }} \
            sh -c "apt-get update -qq && apt-get install -y -qq postgresql-client && psql \$DATABASE_URL -f /migrations/${{ github.event.inputs.migration_file }}"
          
          echo ""
          echo "‚úÖ Migration applied successfully"
      
      - name: Verify Tables
        run: |
          echo "üìä Verifying database schema..."
          docker run --rm \
            -e DATABASE_URL="${{ steps.db.outputs.database_url }}" \
            ${{ steps.image.outputs.image }} \
            sh -c "apt-get update -qq && apt-get install -y -qq postgresql-client && psql \$DATABASE_URL -c '\\dt'"
      
      - name: Results
        run: |
          echo "‚úÖ Migration completed successfully"
          echo ""
          echo "Applied: ${{ github.event.inputs.migration_file }}"
          echo ""
          echo "Next steps:"
          echo "1. Deploy updated backend: https://github.com/${{ github.repository }}/actions/workflows/deploy-backend.yml"
          echo "2. Deploy updated frontend: https://github.com/${{ github.repository }}/actions/workflows/update-frontend.yml"
