name: Configure Backend with ALB

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECS_CLUSTER: field-service-cluster
  ECS_SERVICE: field-service-backend
  CONTAINER_NAME: backend

jobs:
  setup:
    name: Setup ALB for Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get VPC and Subnets
        id: vpc
        run: |
          echo "Getting VPC configuration..."
          
          # Use the existing VPC
          VPC_ID="vpc-0940a20aa85d8f6bb"
          
          echo "VPC_ID=$VPC_ID" >> $GITHUB_OUTPUT
          echo "VPC: $VPC_ID"
          
          # Get first 2 subnets from VPC for ALB
          SUBNET_1=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --query 'Subnets[0].SubnetId' \
            --output text)
          
          SUBNET_2=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --query 'Subnets[1].SubnetId' \
            --output text)
          
          echo "SUBNET_1=$SUBNET_1" >> $GITHUB_OUTPUT
          echo "SUBNET_2=$SUBNET_2" >> $GITHUB_OUTPUT
          echo "Subnets: $SUBNET_1, $SUBNET_2"

      - name: Create or Get ALB Security Group
        id: alb-sg
        run: |
          echo "Setting up ALB Security Group..."
          
          VPC_ID="${{ steps.vpc.outputs.VPC_ID }}"
          
          ALB_SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=field-service-alb-sg" "Name=vpc-id,Values=$VPC_ID" \
            --query 'SecurityGroups[0].GroupId' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$ALB_SG_ID" ] || [ "$ALB_SG_ID" = "None" ]; then
            echo "Creating ALB Security Group..."
            ALB_SG_ID=$(aws ec2 create-security-group \
              --group-name "field-service-alb-sg" \
              --description "ALB for Field Service Backend" \
              --vpc-id $VPC_ID \
              --query 'GroupId' \
              --output text)
            
            # Allow HTTP
            aws ec2 authorize-security-group-ingress \
              --group-id $ALB_SG_ID \
              --protocol tcp \
              --port 80 \
              --cidr 0.0.0.0/0
            
            # Allow HTTPS
            aws ec2 authorize-security-group-ingress \
              --group-id $ALB_SG_ID \
              --protocol tcp \
              --port 443 \
              --cidr 0.0.0.0/0
            
            echo "Created: $ALB_SG_ID"
          else
            echo "Using existing: $ALB_SG_ID"
          fi
          
          echo "ALB_SG_ID=$ALB_SG_ID" >> $GITHUB_OUTPUT

      - name: Update Backend Security Group
        run: |
          echo "Updating Backend Security Group..."
          
          ALB_SG_ID="${{ steps.alb-sg.outputs.ALB_SG_ID }}"
          
          BACKEND_SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=field-service-backend-sg" \
            --query 'SecurityGroups[0].GroupId' \
            --output text)
          
          echo "Backend SG: $BACKEND_SG_ID"
          
          # Allow ALB to access backend
          aws ec2 authorize-security-group-ingress \
            --group-id $BACKEND_SG_ID \
            --protocol tcp \
            --port 3000 \
            --source-group $ALB_SG_ID 2>/dev/null || echo "Rule exists"

      - name: Create or Get Load Balancer
        id: alb
        run: |
          echo "Setting up Application Load Balancer..."
          
          SUBNET_1="${{ steps.vpc.outputs.SUBNET_1 }}"
          SUBNET_2="${{ steps.vpc.outputs.SUBNET_2 }}"
          ALB_SG_ID="${{ steps.alb-sg.outputs.ALB_SG_ID }}"
          
          ALB_ARN=$(aws elbv2 describe-load-balancers \
            --names field-service-alb \
            --query 'LoadBalancers[0].LoadBalancerArn' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$ALB_ARN" ] || [ "$ALB_ARN" = "None" ]; then
            echo "Creating ALB..."
            ALB_ARN=$(aws elbv2 create-load-balancer \
              --name field-service-alb \
              --subnets $SUBNET_1 $SUBNET_2 \
              --security-groups $ALB_SG_ID \
              --scheme internet-facing \
              --type application \
              --query 'LoadBalancers[0].LoadBalancerArn' \
              --output text)
            echo "Created: $ALB_ARN"
            sleep 10
          else
            echo "Using existing: $ALB_ARN"
          fi
          
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --load-balancer-arns $ALB_ARN \
            --query 'LoadBalancers[0].DNSName' \
            --output text)
          
          echo "ALB_ARN=$ALB_ARN" >> $GITHUB_OUTPUT
          echo "ALB_DNS=$ALB_DNS" >> $GITHUB_OUTPUT
          echo "DNS: $ALB_DNS"

      - name: Create or Get Target Group
        id: tg
        run: |
          echo "Setting up Target Group..."
          
          VPC_ID="${{ steps.vpc.outputs.VPC_ID }}"
          
          TG_ARN=$(aws elbv2 describe-target-groups \
            --names field-service-tg \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$TG_ARN" ] || [ "$TG_ARN" = "None" ]; then
            echo "Creating Target Group..."
            TG_ARN=$(aws elbv2 create-target-group \
              --name field-service-tg \
              --protocol HTTP \
              --port 3000 \
              --vpc-id $VPC_ID \
              --target-type ip \
              --health-check-path /health \
              --health-check-interval-seconds 30 \
              --health-check-timeout-seconds 5 \
              --healthy-threshold-count 2 \
              --unhealthy-threshold-count 3 \
              --query 'TargetGroups[0].TargetGroupArn' \
              --output text)
            echo "Created: $TG_ARN"
          else
            echo "Using existing: $TG_ARN"
          fi
          
          echo "TG_ARN=$TG_ARN" >> $GITHUB_OUTPUT

      - name: Create or Get ALB Listener
        run: |
          echo "Setting up ALB Listener..."
          
          ALB_ARN="${{ steps.alb.outputs.ALB_ARN }}"
          TG_ARN="${{ steps.tg.outputs.TG_ARN }}"
          
          LISTENER_ARN=$(aws elbv2 describe-listeners \
            --load-balancer-arn $ALB_ARN \
            --query 'Listeners[?Port==`80`].ListenerArn' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$LISTENER_ARN" ]; then
            echo "Creating listener..."
            aws elbv2 create-listener \
              --load-balancer-arn $ALB_ARN \
              --protocol HTTP \
              --port 80 \
              --default-actions Type=forward,TargetGroupArn=$TG_ARN
            echo "Listener created"
          else
            echo "Listener exists"
          fi

      - name: Get ECS Service Configuration
        id: ecs-config
        run: |
          set -e
          exec 2>/dev/null  # Suppress all stderr
          echo "Getting ECS service configuration..."
          
          # Check if service exists
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].status' \
            --output text || echo "NONE")
          
          echo "Service status: $SERVICE_STATUS"
          
          if [ "$SERVICE_STATUS" = "ACTIVE" ]; then
            # Get config from existing service
            TASK_DEF=$(aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE }} \
              --query 'services[0].taskDefinition' \
              --output text)
            
            SUBNET_LIST=$(aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE }} \
              --query 'join(`,`, services[0].networkConfiguration.awsvpcConfiguration.subnets)' \
              --output text)
            
            SG=$(aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE }} \
              --query 'services[0].networkConfiguration.awsvpcConfiguration.securityGroups[0]' \
              --output text)
            
            SERVICE_FLAG="true"
          else
            # Use defaults
            TASK_DEF=$(aws ecs list-task-definitions \
              --family-prefix field-service-backend \
              --sort DESC \
              --max-items 1 \
              --query 'taskDefinitionArns[0]' \
              --output text)
            
            VPC_ID="vpc-0940a20aa85d8f6bb"
            SUBNET_LIST=$(aws ec2 describe-subnets \
              --filters "Name=vpc-id,Values=$VPC_ID" \
              --query 'join(`,`, Subnets[*].SubnetId)' \
              --output text)
            
            SG=$(aws ec2 describe-security-groups \
              --filters "Name=group-name,Values=field-service-backend-sg" \
              --query 'SecurityGroups[0].GroupId' \
              --output text)
            
            SERVICE_FLAG="false"
          fi
          
          # Display values
          echo "Task Definition: $TASK_DEF"
          echo "Security Group: $SG"
          echo "Subnet List: $SUBNET_LIST"
          exec 2>&1  # Restore stderr for error messages
          
          # Validate
          if [ -z "$TASK_DEF" ] || [ "$TASK_DEF" = "None" ]; then
            echo "ERROR: Invalid TASK_DEF value"
            exit 1
          fi
          
          if [ -z "$SUBNET_LIST" ] || [ "$SUBNET_LIST" = "None" ]; then
            echo "ERROR: Invalid SUBNET_LIST value"
            exit 1
          fi
          
          if [ -z "$SG" ] || [ "$SG" = "None" ]; then
            echo "ERROR: Invalid SG value"
            exit 1
          fi
          
          # Write to GitHub Output
          echo "SERVICE_EXISTS=$SERVICE_FLAG" >> "$GITHUB_OUTPUT"
          echo "TASK_DEF=$TASK_DEF" >> "$GITHUB_OUTPUT"
          echo "SUBNET_LIST=$SUBNET_LIST" >> "$GITHUB_OUTPUT"
          echo "SG=$SG" >> "$GITHUB_OUTPUT"
          
          echo "âœ… Configuration saved"

      - name: Delete Existing Service
        if: steps.ecs-config.outputs.SERVICE_EXISTS == 'true'
        run: |
          echo "Deleting existing service..."
          
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --desired-count 0
          
          echo "Waiting for tasks to stop..."
          sleep 45
          
          aws ecs delete-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --force
          
          echo "Waiting for cleanup..."
          sleep 30

      - name: Create ECS Service with ALB
        run: |
          echo "Creating ECS service with ALB..."
          
          TG_ARN="${{ steps.tg.outputs.TG_ARN }}"
          TASK_DEF="${{ steps.ecs-config.outputs.TASK_DEF }}"
          SUBNET_LIST="${{ steps.ecs-config.outputs.SUBNET_LIST }}"
          SG="${{ steps.ecs-config.outputs.SG }}"
          
          aws ecs create-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service-name ${{ env.ECS_SERVICE }} \
            --task-definition $TASK_DEF \
            --desired-count 1 \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$SUBNET_LIST],securityGroups=[$SG],assignPublicIp=ENABLED}" \
            --load-balancers "targetGroupArn=$TG_ARN,containerName=${{ env.CONTAINER_NAME }},containerPort=3000" \
            --health-check-grace-period-seconds 60
          
          echo "âœ… Service created"

      - name: Wait for Service
        run: |
          echo "Waiting for service to become healthy..."
          
          for i in {1..20}; do
            echo "Check $i/20..."
            
            RUNNING=$(aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE }} \
              --query 'services[0].runningCount' \
              --output text)
            
            echo "Running tasks: $RUNNING"
            
            if [ "$RUNNING" = "1" ]; then
              echo "âœ… Service running"
              break
            fi
            
            sleep 15
          done
          
          # Wait for target health
          echo "Waiting for target to be healthy..."
          sleep 30

      - name: Test Backend
        run: |
          ALB_DNS="${{ steps.alb.outputs.ALB_DNS }}"
          
          echo "Testing backend..."
          curl -v http://$ALB_DNS/health || echo "Health check pending..."

      - name: Display Results
        run: |
          ALB_DNS="${{ steps.alb.outputs.ALB_DNS }}"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… BACKEND ALB CONFIGURATION COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ Backend URL: http://$ALB_DNS"
          echo "ğŸ“ Health: http://$ALB_DNS/health"
          echo "ğŸ“ API: http://$ALB_DNS/api"
          echo ""
          echo "âš ï¸  Next Step: Update frontend with this URL"
          echo "   Run: Update Frontend with Backend URL"
          echo "   Use: $ALB_DNS (without http://)"
          echo ""
          echo "ğŸ”‘ Test Credentials:"
          echo "   Email: admin@fieldservice.com"
          echo "   Password: admin123"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
