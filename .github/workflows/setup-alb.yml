name: Setup ALB

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  VPC_ID: vpc-0940a20aa85d8f6bb

jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Subnets
        id: subnets
        run: |
          S1=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=${{ env.VPC_ID }}" --query 'Subnets[0].SubnetId' --output text)
          S2=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=${{ env.VPC_ID }}" --query 'Subnets[1].SubnetId' --output text)
          echo "s1=$S1" >> $GITHUB_OUTPUT
          echo "s2=$S2" >> $GITHUB_OUTPUT

      - name: Create ALB Security Group
        id: albsg
        run: |
          SG=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=alb-sg" "Name=vpc-id,Values=${{ env.VPC_ID }}" --query 'SecurityGroups[0].GroupId' --output text 2>/dev/null || echo "")
          
          if [ -z "$SG" ] || [ "$SG" = "None" ]; then
            echo "Creating new ALB security group..."
            SG=$(aws ec2 create-security-group \
              --group-name alb-sg \
              --description "ALB SG" \
              --vpc-id ${{ env.VPC_ID }} \
              --query 'GroupId' \
              --output text)
            
            echo "Created SG: $SG"
            
            aws ec2 authorize-security-group-ingress \
              --group-id $SG \
              --protocol tcp \
              --port 80 \
              --cidr 0.0.0.0/0
            
            echo "Added port 80 rule"
          else
            echo "Using existing SG: $SG"
          fi
          
          # Validate
          if [ -z "$SG" ] || [ "$SG" = "None" ]; then
            echo "ERROR: Failed to get/create security group"
            exit 1
          fi
          
          echo "id=$SG" >> $GITHUB_OUTPUT
          echo "Security Group ID: $SG"

      - name: Update Backend Security Group
        run: |
          BSG=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=field-service-backend-sg" --query 'SecurityGroups[0].GroupId' --output text)
          aws ec2 authorize-security-group-ingress --group-id $BSG --protocol tcp --port 3000 --source-group ${{ steps.albsg.outputs.id }} 2>/dev/null || true

      - name: Create ALB
        id: alb
        run: |
          ARN=$(aws elbv2 describe-load-balancers --names fs-alb --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || echo "")
          if [ -z "$ARN" ]; then
            ARN=$(aws elbv2 create-load-balancer --name fs-alb --subnets ${{ steps.subnets.outputs.s1 }} ${{ steps.subnets.outputs.s2 }} --security-groups ${{ steps.albsg.outputs.id }} --query 'LoadBalancers[0].LoadBalancerArn' --output text)
            sleep 15
          fi
          DNS=$(aws elbv2 describe-load-balancers --load-balancer-arns $ARN --query 'LoadBalancers[0].DNSName' --output text)
          echo "arn=$ARN" >> $GITHUB_OUTPUT
          echo "dns=$DNS" >> $GITHUB_OUTPUT
          echo "ALB: $DNS"

      - name: Create Target Group
        id: tg
        run: |
          TG=$(aws elbv2 describe-target-groups --names fs-tg --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || echo "")
          if [ -z "$TG" ]; then
            TG=$(aws elbv2 create-target-group --name fs-tg --protocol HTTP --port 3000 --vpc-id ${{ env.VPC_ID }} --target-type ip --health-check-path /health --query 'TargetGroups[0].TargetGroupArn' --output text)
          fi
          echo "arn=$TG" >> $GITHUB_OUTPUT

      - name: Create Listener
        run: |
          L=$(aws elbv2 describe-listeners --load-balancer-arn ${{ steps.alb.outputs.arn }} --query 'Listeners[0].ListenerArn' --output text 2>/dev/null || echo "")
          if [ -z "$L" ]; then
            aws elbv2 create-listener --load-balancer-arn ${{ steps.alb.outputs.arn }} --protocol HTTP --port 80 --default-actions Type=forward,TargetGroupArn=${{ steps.tg.outputs.arn }}
          fi

      - name: Get ECS Info
        id: ecs
        run: |
          exec 2>/dev/null
          TD=$(aws ecs list-task-definitions --family-prefix field-service-backend --sort DESC --max-items 1 --query 'taskDefinitionArns[0]' --output text)
          SUBS=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=${{ env.VPC_ID }}" --query 'Subnets[*].SubnetId' --output text | sed 's/\t/,/g')
          SG=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=field-service-backend-sg" --query 'SecurityGroups[0].GroupId' --output text)
          exec 2>&1
          
          echo "Task Def: $TD"
          echo "Subnets: $SUBS"
          echo "SG: $SG"
          
          echo "td=$TD" >> $GITHUB_OUTPUT
          echo "subs=$SUBS" >> $GITHUB_OUTPUT
          echo "sg=$SG" >> $GITHUB_OUTPUT

      - name: Delete Old Service
        run: |
          ST=$(aws ecs describe-services --cluster field-service-cluster --services field-service-backend --query 'services[0].status' --output text 2>/dev/null || echo "NONE")
          if [ "$ST" = "ACTIVE" ]; then
            aws ecs update-service --cluster field-service-cluster --service field-service-backend --desired-count 0
            sleep 30
            aws ecs delete-service --cluster field-service-cluster --service field-service-backend --force
            sleep 20
          fi

      - name: Create Service
        run: |
          aws ecs create-service \
            --cluster field-service-cluster \
            --service-name field-service-backend \
            --task-definition ${{ steps.ecs.outputs.td }} \
            --desired-count 1 \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ steps.ecs.outputs.subs }}],securityGroups=[${{ steps.ecs.outputs.sg }}],assignPublicIp=ENABLED}" \
            --load-balancers "targetGroupArn=${{ steps.tg.outputs.arn }},containerName=backend,containerPort=3000" \
            --health-check-grace-period-seconds 60

      - name: Wait
        run: |
          for i in {1..20}; do
            R=$(aws ecs describe-services --cluster field-service-cluster --services field-service-backend --query 'services[0].runningCount' --output text)
            echo "Check $i: $R tasks"
            [ "$R" = "1" ] && break
            sleep 15
          done

      - name: Results
        run: |
          echo "âœ… Complete"
          echo "URL: http://${{ steps.alb.outputs.dns }}"
          echo "Next: Update frontend with: ${{ steps.alb.outputs.dns }}"
