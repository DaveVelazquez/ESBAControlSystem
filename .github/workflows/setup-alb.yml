name: Setup Application Load Balancer

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  VPC_ID: vpc-0940a20aa85d8f6bb
  ECS_CLUSTER: field-service-cluster
  ECS_SERVICE: field-service-backend
  CONTAINER_NAME: backend
  CONTAINER_PORT: 3000

jobs:
  setup-alb:
    name: Configure ALB for Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Subnets
        id: subnets
        run: |
          SUBNET_1=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=${{ env.VPC_ID }}" --query 'Subnets[0].SubnetId' --output text)
          SUBNET_2=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=${{ env.VPC_ID }}" --query 'Subnets[1].SubnetId' --output text)
          
          echo "subnet1=$SUBNET_1" >> $GITHUB_OUTPUT
          echo "subnet2=$SUBNET_2" >> $GITHUB_OUTPUT
          echo "Subnets: $SUBNET_1, $SUBNET_2"

      - name: Create ALB Security Group
        id: alb-sg
        run: |
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=field-service-alb-sg" \
            --query 'SecurityGroups[0].GroupId' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$SG_ID" ]; then
            echo "Creating ALB Security Group..."
            SG_ID=$(aws ec2 create-security-group \
              --group-name field-service-alb-sg \
              --description "Security group for ALB" \
              --vpc-id ${{ env.VPC_ID }} \
              --query 'GroupId' \
              --output text)
            
            aws ec2 authorize-security-group-ingress --group-id $SG_ID --protocol tcp --port 80 --cidr 0.0.0.0/0
            aws ec2 authorize-security-group-ingress --group-id $SG_ID --protocol tcp --port 443 --cidr 0.0.0.0/0
          fi
          
          echo "sg_id=$SG_ID" >> $GITHUB_OUTPUT
          echo "ALB SG: $SG_ID"

      - name: Update Backend Security Group
        run: |
          BACKEND_SG=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=field-service-backend-sg" \
            --query 'SecurityGroups[0].GroupId' \
            --output text)
          
          aws ec2 authorize-security-group-ingress \
            --group-id $BACKEND_SG \
            --protocol tcp \
            --port ${{ env.CONTAINER_PORT }} \
            --source-group ${{ steps.alb-sg.outputs.sg_id }} 2>/dev/null || echo "Rule exists"

      - name: Create Load Balancer
        id: alb
        run: |
          ALB_ARN=$(aws elbv2 describe-load-balancers \
            --names field-service-alb \
            --query 'LoadBalancers[0].LoadBalancerArn' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$ALB_ARN" ]; then
            echo "Creating ALB..."
            ALB_ARN=$(aws elbv2 create-load-balancer \
              --name field-service-alb \
              --subnets ${{ steps.subnets.outputs.subnet1 }} ${{ steps.subnets.outputs.subnet2 }} \
              --security-groups ${{ steps.alb-sg.outputs.sg_id }} \
              --scheme internet-facing \
              --type application \
              --query 'LoadBalancers[0].LoadBalancerArn' \
              --output text)
            
            echo "Waiting for ALB..."
            sleep 15
          fi
          
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --load-balancer-arns $ALB_ARN \
            --query 'LoadBalancers[0].DNSName' \
            --output text)
          
          echo "alb_arn=$ALB_ARN" >> $GITHUB_OUTPUT
          echo "alb_dns=$ALB_DNS" >> $GITHUB_OUTPUT
          echo "ALB DNS: $ALB_DNS"

      - name: Create Target Group
        id: tg
        run: |
          TG_ARN=$(aws elbv2 describe-target-groups \
            --names field-service-tg \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$TG_ARN" ]; then
            echo "Creating Target Group..."
            TG_ARN=$(aws elbv2 create-target-group \
              --name field-service-tg \
              --protocol HTTP \
              --port ${{ env.CONTAINER_PORT }} \
              --vpc-id ${{ env.VPC_ID }} \
              --target-type ip \
              --health-check-path /health \
              --health-check-interval-seconds 30 \
              --query 'TargetGroups[0].TargetGroupArn' \
              --output text)
          fi
          
          echo "tg_arn=$TG_ARN" >> $GITHUB_OUTPUT
          echo "Target Group: $TG_ARN"

      - name: Create Listener
        run: |
          LISTENER=$(aws elbv2 describe-listeners \
            --load-balancer-arn ${{ steps.alb.outputs.alb_arn }} \
            --query 'Listeners[?Port==`80`].ListenerArn' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$LISTENER" ]; then
            echo "Creating listener..."
            aws elbv2 create-listener \
              --load-balancer-arn ${{ steps.alb.outputs.alb_arn }} \
              --protocol HTTP \
              --port 80 \
              --default-actions Type=forward,TargetGroupArn=${{ steps.tg.outputs.tg_arn }}
          fi

      - name: Get ECS Configuration
        id: ecs
        run: |
          set -euo pipefail
          
          TASK_DEF=$(aws ecs list-task-definitions \
            --family-prefix field-service-backend \
            --sort DESC \
            --max-items 1 \
            --query 'taskDefinitionArns[0]' \
            --output text)
          
          # Get subnets as array, then join manually
          SUBNET_JSON=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=${{ env.VPC_ID }}" \
            --query 'Subnets[*].SubnetId' \
            --output json)
          
          # Convert JSON array to comma-separated string in bash
          SUBNETS=$(echo "$SUBNET_JSON" | grep -o 'subnet-[a-z0-9]*' | paste -sd ',' -)
          
          SG=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=field-service-backend-sg" \
            --query 'SecurityGroups[0].GroupId' \
            --output text)
          
          # Validate values
          if [ -z "$TASK_DEF" ]; then
            echo "ERROR: TASK_DEF is empty"
            exit 1
          fi
          
          if [ -z "$SUBNETS" ]; then
            echo "ERROR: SUBNETS is empty"
            exit 1
          fi
          
          if [ -z "$SG" ]; then
            echo "ERROR: SG is empty"
            exit 1
          fi
          
          echo "Task: $TASK_DEF"
          echo "Subnets: $SUBNETS"
          echo "SG: $SG"
          
          # Write to temp file first, then copy to GITHUB_OUTPUT
          TEMP_FILE=$(mktemp)
          cat > "$TEMP_FILE" << 'ENDOFOUTPUT'
task_def=$TASK_DEF
subnets=$SUBNETS
security_group=$SG
ENDOFOUTPUT
          
          # Replace variables
          sed -i "s|\$TASK_DEF|$TASK_DEF|g" "$TEMP_FILE"
          sed -i "s|\$SUBNETS|$SUBNETS|g" "$TEMP_FILE"
          sed -i "s|\$SG|$SG|g" "$TEMP_FILE"
          
          # Copy to GITHUB_OUTPUT
          cat "$TEMP_FILE" >> $GITHUB_OUTPUT
          rm "$TEMP_FILE"

      - name: Check Existing Service
        id: check
        run: |
          STATUS=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].status' \
            --output text 2>/dev/null || echo "NONE")
          
          echo "exists=$([[ "$STATUS" == "ACTIVE" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "Service exists: $([[ "$STATUS" == "ACTIVE" ]] && echo yes || echo no)"

      - name: Delete Old Service
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "Stopping old service..."
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --desired-count 0
          
          sleep 30
          
          aws ecs delete-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --force
          
          sleep 20

      - name: Create ECS Service with ALB
        run: |
          echo "Creating ECS service..."
          
          aws ecs create-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service-name ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.ecs.outputs.task_def }} \
            --desired-count 1 \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ steps.ecs.outputs.subnets }}],securityGroups=[${{ steps.ecs.outputs.security_group }}],assignPublicIp=ENABLED}" \
            --load-balancers "targetGroupArn=${{ steps.tg.outputs.tg_arn }},containerName=${{ env.CONTAINER_NAME }},containerPort=${{ env.CONTAINER_PORT }}" \
            --health-check-grace-period-seconds 60

      - name: Wait for Service
        run: |
          echo "Waiting for service to stabilize..."
          
          for i in {1..20}; do
            RUNNING=$(aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE }} \
              --query 'services[0].runningCount' \
              --output text)
            
            echo "Attempt $i: Running tasks = $RUNNING"
            
            if [ "$RUNNING" = "1" ]; then
              echo "âœ… Service is running"
              break
            fi
            
            sleep 15
          done

      - name: Display Results
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ALB SETUP COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ Backend URL: http://${{ steps.alb.outputs.alb_dns }}"
          echo "ğŸ“ Health: http://${{ steps.alb.outputs.alb_dns }}/health"
          echo ""
          echo "Next: Update frontend with: ${{ steps.alb.outputs.alb_dns }}"
          echo ""
