name: Setup CloudFront with HTTPS

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  S3_BUCKET: field-service-frontend-prod

jobs:
  setup-cloudfront:
    name: Configure CloudFront Distribution
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create CloudFront Origin Access Identity
        id: create-oai
        run: |
          echo "ğŸ” Creating CloudFront Origin Access Identity..."
          
          # Check if OAI already exists
          OAI_ID=$(aws cloudfront list-cloud-front-origin-access-identities \
            --query "CloudFrontOriginAccessIdentityList.Items[?Comment=='field-service-frontend'].Id" \
            --output text)
          
          if [ -z "$OAI_ID" ] || [ "$OAI_ID" = "None" ]; then
            echo "Creating new OAI..."
            OAI_ID=$(aws cloudfront create-cloud-front-origin-access-identity \
              --cloud-front-origin-access-identity-config \
                CallerReference=$(date +%s),Comment="field-service-frontend" \
              --query 'CloudFrontOriginAccessIdentity.Id' \
              --output text)
          else
            echo "Using existing OAI: $OAI_ID"
          fi
          
          echo "OAI_ID=$OAI_ID" >> $GITHUB_OUTPUT
          echo "âœ… OAI ID: $OAI_ID"

      - name: Update S3 bucket policy for CloudFront
        run: |
          echo "ğŸ“ Updating S3 bucket policy..."
          
          OAI_ID="${{ steps.create-oai.outputs.OAI_ID }}"
          
          # Get the canonical user ID for the OAI
          CANONICAL_USER=$(aws cloudfront get-cloud-front-origin-access-identity \
            --id $OAI_ID \
            --query 'CloudFrontOriginAccessIdentity.S3CanonicalUserId' \
            --output text)
          
          echo "Canonical User: $CANONICAL_USER"
          
          cat > bucket-policy.json << EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "AllowCloudFrontOAI",
                "Effect": "Allow",
                "Principal": {
                  "CanonicalUser": "$CANONICAL_USER"
                },
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::${{ env.S3_BUCKET }}/*"
              }
            ]
          }
          EOF
          
          cat bucket-policy.json
          
          aws s3api put-bucket-policy \
            --bucket ${{ env.S3_BUCKET }} \
            --policy file://bucket-policy.json
          
          echo "âœ… Bucket policy updated"

      - name: Create CloudFront distribution
        id: create-distribution
        run: |
          echo "â˜ï¸ Creating CloudFront distribution..."
          
          # Check if distribution already exists
          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='field-service-frontend'].Id" \
            --output text)
          
          if [ -z "$DIST_ID" ] || [ "$DIST_ID" = "None" ]; then
            echo "Creating new CloudFront distribution..."
            
            cat > distribution-config.json << EOF
          {
            "CallerReference": "field-service-$(date +%s)",
            "Comment": "field-service-frontend",
            "Enabled": true,
            "DefaultRootObject": "index.html",
            "Origins": {
              "Quantity": 1,
              "Items": [
                {
                  "Id": "S3-${{ env.S3_BUCKET }}",
                  "DomainName": "${{ env.S3_BUCKET }}.s3.amazonaws.com",
                  "S3OriginConfig": {
                    "OriginAccessIdentity": "origin-access-identity/cloudfront/${{ steps.create-oai.outputs.OAI_ID }}"
                  }
                }
              ]
            },
            "DefaultCacheBehavior": {
              "TargetOriginId": "S3-${{ env.S3_BUCKET }}",
              "ViewerProtocolPolicy": "redirect-to-https",
              "AllowedMethods": {
                "Quantity": 2,
                "Items": ["GET", "HEAD"],
                "CachedMethods": {
                  "Quantity": 2,
                  "Items": ["GET", "HEAD"]
                }
              },
              "ForwardedValues": {
                "QueryString": false,
                "Cookies": {
                  "Forward": "none"
                }
              },
              "MinTTL": 0,
              "DefaultTTL": 86400,
              "MaxTTL": 31536000,
              "Compress": true
            },
            "CustomErrorResponses": {
              "Quantity": 2,
              "Items": [
                {
                  "ErrorCode": 403,
                  "ResponsePagePath": "/index.html",
                  "ResponseCode": "200",
                  "ErrorCachingMinTTL": 300
                },
                {
                  "ErrorCode": 404,
                  "ResponsePagePath": "/index.html",
                  "ResponseCode": "200",
                  "ErrorCachingMinTTL": 300
                }
              ]
            },
            "ViewerCertificate": {
              "CloudFrontDefaultCertificate": true,
              "MinimumProtocolVersion": "TLSv1.2_2021"
            }
          }
          EOF
            
            DIST_ID=$(aws cloudfront create-distribution \
              --distribution-config file://distribution-config.json \
              --query 'Distribution.Id' \
              --output text)
            
            echo "Created distribution: $DIST_ID"
          else
            echo "Using existing distribution: $DIST_ID"
          fi
          
          echo "DIST_ID=$DIST_ID" >> $GITHUB_OUTPUT
          
          # Get distribution domain
          DOMAIN=$(aws cloudfront get-distribution \
            --id $DIST_ID \
            --query 'Distribution.DomainName' \
            --output text)
          
          echo "DOMAIN=$DOMAIN" >> $GITHUB_OUTPUT
          
          echo "âœ… CloudFront distribution ready"
          echo "Distribution ID: $DIST_ID"
          echo "Domain: $DOMAIN"

      - name: Wait for distribution deployment
        run: |
          echo "â³ Waiting for CloudFront distribution to deploy..."
          echo "This may take 5-10 minutes..."
          
          DIST_ID="${{ steps.create-distribution.outputs.DIST_ID }}"
          
          for i in {1..40}; do
            STATUS=$(aws cloudfront get-distribution \
              --id $DIST_ID \
              --query 'Distribution.Status' \
              --output text)
            
            echo "Check $i/40: Status = $STATUS"
            
            if [ "$STATUS" = "Deployed" ]; then
              echo "âœ… Distribution deployed!"
              break
            fi
            
            sleep 15
          done

      - name: Display URLs
        run: |
          DOMAIN="${{ steps.create-distribution.outputs.DOMAIN }}"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… CLOUDFRONT SETUP COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ HTTPS URL: https://$DOMAIN"
          echo "ğŸ“± Mobile-ready with SSL certificate"
          echo ""
          echo "ğŸ”‘ Test Credentials:"
          echo "   â€¢ Email: admin@fieldservice.com"
          echo "   â€¢ Password: admin123"
          echo ""
          echo "âš ï¸  Note: Distribution may take up to 15 minutes to fully propagate"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
